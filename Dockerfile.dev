# Development Dockerfile for hot reloading
ARG NODE_VERSION=18

FROM node:${NODE_VERSION}-alpine AS base
# Install pnpm
RUN npm install -g pnpm
# Install curl for healthchecks
RUN apk add --no-cache curl

FROM base AS dev-deps
WORKDIR /app

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml turbo.json ./
COPY apps/*/package.json ./apps/*/
COPY packages/*/package.json ./packages/*/

# Install all dependencies (including dev)
RUN pnpm install --frozen-lockfile

# API Development
FROM dev-deps AS api-dev
WORKDIR /app

# Copy source code
COPY . .

# Create non-root user
RUN addgroup -g 1001 -S nodejs && adduser -S api -u 1001 -G nodejs
RUN chown -R api:nodejs /app
USER api

EXPOSE 3001
WORKDIR /app/apps/api

CMD ["pnpm", "dev"]

# Web Development  
FROM dev-deps AS web-dev
WORKDIR /app

# Copy source code
COPY . .

# Create non-root user
RUN addgroup -g 1001 -S nodejs && adduser -S web -u 1001 -G nodejs
RUN chown -R api:nodejs /app
USER web

EXPOSE 5173
WORKDIR /app/apps/web

CMD ["pnpm", "dev", "--host", "0.0.0.0"]
